<p-toast></p-toast>

<div class="card">
    <div class="flex flex-col items-center gap-4 mb-6">
        <h2 class="text-2xl font-bold m-0">
            <i class="pi pi-link mr-2" style="color: #4caf50"></i>
            YouTube ÈÄ£ÁµêËß£Êûê
        </h2>
        <div class="flex gap-2 w-full" style="max-width: 600px">
            <input type="text" pInputText [(ngModel)]="parserUrl" placeholder="Ë≤º‰∏ä YouTube ÂΩ±ÁâáÊàñÊí≠ÊîæÊ∏ÖÂñÆÁ∂≤ÂùÄ..." class="w-full" (keydown)="onKeyDown($event)" />
            <p-button icon="pi pi-search" label="Ëß£Êûê" (onClick)="onParse()" [loading]="loading()"></p-button>
        </div>
        <small class="text-gray-500">ÊîØÊè¥ÂñÆ‰∏ÄÂΩ±ÁâáÊàñÊí≠ÊîæÊ∏ÖÂñÆÈÄ£ÁµêËß£Êûê</small>
    </div>

    <!-- Ëß£ÊûêÁµêÊûú -->
    @if (loading()) {
        <div class="flex justify-center p-8">
            <i class="pi pi-spin pi-spinner" style="font-size: 2rem"></i>
        </div>
    }

    @if (videos().length > 0) {
        <div class="flex justify-between items-center mb-4">
            <h3 class="text-lg font-semibold m-0">Ëß£ÊûêÁµêÊûú ({{ videos().length }})</h3>
            <div class="flex gap-2">
                <p-button label="ÂÖ®ÈÉ®‰∏ãËºâ (MP3)" icon="pi pi-download" severity="info" [outlined]="true" (onClick)="downloadAll('audio')" [disabled]="loading()"></p-button>
                <p-button label="ÂÖ®ÈÉ®‰∏ãËºâ (MP4)" icon="pi pi-video" severity="help" [outlined]="true" (onClick)="downloadAll('video')" [disabled]="loading()"></p-button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
            @for (video of videos(); track video.videoId) {
                <div class="card p-0 overflow-hidden shadow-md hover:shadow-lg transition-shadow cursor-pointer">
                    <!-- Á∏ÆÂúñ -->
                    <div class="relative">
                        <img [src]="video.thumbnail" [alt]="video.title" class="w-full aspect-video object-cover" />
                        <p-tag [value]="video.duration" severity="secondary" class="absolute bottom-2 right-2" [style]="{ background: 'rgba(0,0,0,0.8)', color: '#fff' }"></p-tag>
                    </div>

                    <!-- Ë≥áË®ä -->
                    <div class="p-3">
                        <h4 class="text-sm font-semibold m-0 mb-2 line-clamp-2" [title]="video.title">
                            {{ video.title }}
                        </h4>
                        <p class="text-xs text-gray-500 m-0 mb-1">
                            <i class="pi pi-user mr-1"></i>
                            {{ video.channel }}
                        </p>
                        <div class="flex justify-between items-center text-xs text-gray-400">
                            <span>
                                <i class="pi pi-eye mr-1"></i>
                                {{ formatData(video.viewCount) }}
                            </span>
                            <span>{{ video.publishedAt }}</span>
                        </div>

                        <!-- ‰∏ãËºâÊåâÈàïÊàñÈÄ≤Â∫¶Ê¢ù -->
                        <div class="mt-3">
                            @if (taskMap().get(video.videoId); as task) {
                                <div class="flex flex-col gap-1">
                                    <div class="flex justify-between text-xs text-gray-600 mb-1">
                                        <span>
                                            @if (task.status === 'completed') { <i class="pi pi-check-circle text-green-500 mr-1"></i>ÂÆåÊàê }
                                            @else if (task.status === 'failed') { <i class="pi pi-times-circle text-red-500 mr-1"></i>Â§±Êïó }
                                            @else { <i class="pi pi-spin pi-spinner text-blue-500 mr-1"></i>‰∏ãËºâ‰∏≠... }
                                        </span>
                                        <span>{{ task.progress }}%</span>
                                    </div>
                                    <p-progressBar 
                                        [value]="task.progress" 
                                        [showValue]="false" 
                                        [style]="{ height: '6px' }" 
                                        [color]="task.status === 'failed' ? 'var(--red-500)' : (task.status === 'completed' ? 'var(--green-500)' : 'var(--primary-color)')">
                                    </p-progressBar>
                                    
                                    @if (task.status === 'failed') {
                                        <p-button label="ÈáçË©¶" icon="pi pi-refresh" severity="danger" [outlined]="true" size="small" class="w-full mt-2" styleClass="w-full py-1" (onClick)="openDownloadDialog(video)"></p-button>
                                    }
                                </div>
                            } @else {
                                <p-button icon="pi pi-download" label="‰∏ãËºâ" severity="success" [outlined]="true" class="w-full" styleClass="w-full" (onClick)="openDownloadDialog(video)"></p-button>
                            }
                        </div>
                    </div>
                </div>
            }
        </div>
    }
</div>

<!-- ‰∏ãËºâÊ†ºÂºèÈÅ∏Êìá Dialog -->
<p-dialog header="ÈÅ∏Êìá‰∏ãËºâÊ†ºÂºè" [(visible)]="showDownloadDialog" [modal]="true" [style]="{ width: '450px' }">
    @if (selectedVideo) {
        <div class="flex flex-col gap-4">
            <!-- ÂΩ±ÁâáÈ†êË¶Ω -->
            <div class="flex gap-3 items-start">
                <img [src]="selectedVideo.thumbnail" [alt]="selectedVideo.title" class="rounded" style="width: 120px" />
                <div>
                    <h5 class="m-0 mb-1 text-sm font-semibold">{{ selectedVideo.title }}</h5>
                    <p class="m-0 text-xs text-gray-500">{{ selectedVideo.channel }}</p>
                    <p class="m-0 text-xs text-gray-400">{{ selectedVideo.duration }}</p>
                </div>
            </div>

            <!-- Ê†ºÂºèÈÅ∏Êìá -->
            <div class="flex flex-col gap-3">
                <label class="font-semibold">‰∏ãËºâÈ°ûÂûã</label>
                <div class="flex gap-4">
                    <p-radioButton name="downloadType" value="audio" [(ngModel)]="downloadType" label="üéµ Á¥îÈü≥Ê®Ç (MP3)" inputId="typeAudio"></p-radioButton>
                    <p-radioButton name="downloadType" value="video" [(ngModel)]="downloadType" label="üé¨ ÂΩ±Áâá (MP4)" inputId="typeVideo"></p-radioButton>
                </div>
            </div>

            <!-- ‰∏ãËºâÊåâÈàï -->
            <div class="flex justify-end gap-2 mt-2">
                <p-button label="ÂèñÊ∂à" severity="secondary" [outlined]="true" (onClick)="showDownloadDialog = false"></p-button>
                <p-button label="Âä†ÂÖ•‰∏ãËºâÊéíÁ®ã" icon="pi pi-download" severity="success" (onClick)="onDownload()"></p-button>
            </div>
        </div>
    }
</p-dialog>
